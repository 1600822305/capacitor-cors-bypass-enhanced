<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORSæ’ä»¶æµå¼è¾“å‡ºæµ‹è¯•</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        h2 {
            color: #555;
            margin-top: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #666;
        }
        input, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        textarea {
            min-height: 100px;
            font-family: monospace;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        button.cancel {
            background: #f44336;
        }
        button.cancel:hover {
            background: #da190b;
        }
        .output {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .status.info {
            background: #e3f2fd;
            color: #1976d2;
        }
        .status.success {
            background: #e8f5e9;
            color: #388e3c;
        }
        .status.error {
            background: #ffebee;
            color: #c62828;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .stat-card {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #4CAF50;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒŠ CORSæ’ä»¶æµå¼è¾“å‡ºæµ‹è¯•</h1>
        <p>æµ‹è¯•Capacitor CORSæ’ä»¶çš„æµå¼è¯·æ±‚åŠŸèƒ½ï¼Œæ”¯æŒAIæ¨¡å‹çš„æµå¼è¾“å‡ºã€‚</p>
    </div>

    <div class="container">
        <h2>é…ç½®</h2>
        <div class="form-group">
            <label for="apiUrl">API URL:</label>
            <input type="text" id="apiUrl" placeholder="https://api.openai.com/v1/chat/completions" 
                   value="https://api.openai.com/v1/chat/completions">
        </div>
        <div class="form-group">
            <label for="apiKey">API Key:</label>
            <input type="password" id="apiKey" placeholder="sk-...">
        </div>
        <div class="form-group">
            <label for="model">æ¨¡å‹:</label>
            <input type="text" id="model" placeholder="gpt-3.5-turbo" value="gpt-3.5-turbo">
        </div>
        <div class="form-group">
            <label for="message">æ¶ˆæ¯:</label>
            <textarea id="message" placeholder="è¾“å…¥ä½ çš„é—®é¢˜...">ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±ã€‚</textarea>
        </div>
        <div>
            <button id="startBtn" onclick="startStream()">å¼€å§‹æµå¼è¯·æ±‚</button>
            <button id="cancelBtn" class="cancel" onclick="cancelStream()" disabled>å–æ¶ˆè¯·æ±‚</button>
            <button onclick="clearOutput()">æ¸…ç©ºè¾“å‡º</button>
        </div>
    </div>

    <div class="container">
        <h2>çŠ¶æ€</h2>
        <div id="statusDiv"></div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-label">æ¥æ”¶å­—ç¬¦æ•°</div>
                <div class="stat-value" id="charCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">æ¥æ”¶å—æ•°</div>
                <div class="stat-value" id="chunkCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">è€—æ—¶ (ç§’)</div>
                <div class="stat-value" id="duration">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">çŠ¶æ€</div>
                <div class="stat-value" id="streamStatus">å°±ç»ª</div>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>è¾“å‡º</h2>
        <div class="output" id="output"></div>
    </div>

    <script type="module">
        import { CorsBypass } from './dist/esm/index.js';

        let currentStreamId = null;
        let startTime = null;
        let charCount = 0;
        let chunkCount = 0;
        let durationInterval = null;

        // ç›‘å¬æµå¼æ•°æ®å—
        CorsBypass.addListener('streamChunk', (event) => {
            console.log('æ”¶åˆ°æ•°æ®å—:', event);
            
            if (event.data) {
                charCount += event.data.length;
                chunkCount++;
                
                // æ›´æ–°è¾“å‡º
                const output = document.getElementById('output');
                output.textContent += event.data;
                output.scrollTop = output.scrollHeight;
                
                // æ›´æ–°ç»Ÿè®¡
                document.getElementById('charCount').textContent = charCount;
                document.getElementById('chunkCount').textContent = chunkCount;
            }
            
            if (event.done) {
                if (event.error) {
                    showStatus('error', `é”™è¯¯: ${event.error}`);
                } else {
                    showStatus('success', 'æµå¼è¯·æ±‚å®Œæˆï¼');
                }
                resetUI();
            }
        });

        // ç›‘å¬æµçŠ¶æ€å˜åŒ–
        CorsBypass.addListener('streamStatus', (event) => {
            console.log('æµçŠ¶æ€å˜åŒ–:', event);
            
            const statusMap = {
                'started': 'è¿›è¡Œä¸­',
                'completed': 'å·²å®Œæˆ',
                'error': 'é”™è¯¯',
                'cancelled': 'å·²å–æ¶ˆ'
            };
            
            document.getElementById('streamStatus').textContent = statusMap[event.status] || event.status;
            
            if (event.status === 'started') {
                showStatus('info', `æµå¼è¯·æ±‚å·²å¼€å§‹ (HTTP ${event.statusCode})`);
            } else if (event.status === 'completed') {
                showStatus('success', 'æµå¼è¯·æ±‚æˆåŠŸå®Œæˆï¼');
                resetUI();
            } else if (event.status === 'error') {
                showStatus('error', `é”™è¯¯: ${event.error}`);
                resetUI();
            } else if (event.status === 'cancelled') {
                showStatus('info', 'æµå¼è¯·æ±‚å·²å–æ¶ˆ');
                resetUI();
            }
        });

        window.startStream = async function() {
            const apiUrl = document.getElementById('apiUrl').value;
            const apiKey = document.getElementById('apiKey').value;
            const model = document.getElementById('model').value;
            const message = document.getElementById('message').value;

            if (!apiUrl || !apiKey || !message) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
                return;
            }

            // é‡ç½®ç»Ÿè®¡
            charCount = 0;
            chunkCount = 0;
            startTime = Date.now();
            document.getElementById('charCount').textContent = '0';
            document.getElementById('chunkCount').textContent = '0';
            document.getElementById('duration').textContent = '0';
            document.getElementById('output').textContent = '';

            // æ›´æ–°UI
            document.getElementById('startBtn').disabled = true;
            document.getElementById('cancelBtn').disabled = false;
            showStatus('info', 'æ­£åœ¨å‘èµ·æµå¼è¯·æ±‚...');

            // å¼€å§‹è®¡æ—¶
            durationInterval = setInterval(() => {
                const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
                document.getElementById('duration').textContent = elapsed;
            }, 100);

            try {
                // æ„å»ºè¯·æ±‚æ•°æ®
                const requestData = {
                    model: model,
                    messages: [
                        { role: 'user', content: message }
                    ],
                    stream: true
                };

                // å‘èµ·æµå¼è¯·æ±‚
                const result = await CorsBypass.streamRequest({
                    url: apiUrl,
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    data: requestData,
                    timeout: 60000
                });

                currentStreamId = result.streamId;
                console.log('æµå¼è¯·æ±‚å·²å¯åŠ¨:', currentStreamId);

            } catch (error) {
                console.error('å¯åŠ¨æµå¼è¯·æ±‚å¤±è´¥:', error);
                showStatus('error', `å¯åŠ¨å¤±è´¥: ${error.message}`);
                resetUI();
            }
        };

        window.cancelStream = async function() {
            if (!currentStreamId) return;

            try {
                await CorsBypass.cancelStream({ streamId: currentStreamId });
                console.log('å·²å–æ¶ˆæµå¼è¯·æ±‚');
            } catch (error) {
                console.error('å–æ¶ˆè¯·æ±‚å¤±è´¥:', error);
            }
        };

        window.clearOutput = function() {
            document.getElementById('output').textContent = '';
            charCount = 0;
            chunkCount = 0;
            document.getElementById('charCount').textContent = '0';
            document.getElementById('chunkCount').textContent = '0';
            document.getElementById('duration').textContent = '0';
            showStatus('info', 'è¾“å‡ºå·²æ¸…ç©º');
        };

        function showStatus(type, message) {
            const statusDiv = document.getElementById('statusDiv');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
        }

        function resetUI() {
            document.getElementById('startBtn').disabled = false;
            document.getElementById('cancelBtn').disabled = true;
            currentStreamId = null;
            
            if (durationInterval) {
                clearInterval(durationInterval);
                durationInterval = null;
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆ
        showStatus('success', 'âœ… æ’ä»¶å·²åŠ è½½ï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•');
    </script>
</body>
</html>